#!/bin/bash

# Script de gestion Docker pour SUPCHAT
# Auteur: SUPCHAT Team
# Version: 1.0

# Couleurs pour l'affichage
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Variables
PROJECT_NAME="supchat"
SERVICES=("web" "api" "mobile" "db" "cadvisor")

# Fonction pour afficher le header
show_header() {
    clear
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                    ğŸš€ SUPCHAT DOCKER MANAGER                â•‘"
    echo "â•‘                                                              â•‘"
    echo "â•‘              Gestion complÃ¨te de l'environnement Docker     â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# Fonction pour afficher l'Ã©tat des containers
show_status() {
    echo -e "\n${BLUE}ğŸ“Š Ã‰tat actuel des containers:${NC}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    if docker-compose ps 2>/dev/null | grep -q "supchat"; then
        docker-compose ps
    else
        echo -e "${YELLOW}Aucun container en cours d'exÃ©cution${NC}"
    fi
    echo ""
}

# Fonction pour afficher le menu principal
show_menu() {
    echo -e "${WHITE}ENVIRONNEMENTS COMPLETS (avec build):${NC}"
    echo -e "${GREEN}  1)${NC} ğŸš€ Lancer TOUT en DÃ‰VELOPPEMENT (hot reload + build)"
    echo -e "${PURPLE}  2)${NC} ğŸ­ Lancer TOUT en PRODUCTION (optimisÃ© + build)"
    echo ""
    echo -e "${WHITE}DÃ‰MARRAGE RAPIDE (containers existants):${NC}"
    echo -e "${CYAN} 20)${NC} âš¡ DÃ©marrage RAPIDE DÃ©veloppement (sans rebuild)"
    echo -e "${CYAN} 21)${NC} âš¡ DÃ©marrage RAPIDE Production (sans rebuild)"
    echo -e "${CYAN} 22)${NC} âš¡ DÃ©marrage RAPIDE Tests (sans rebuild)"
    echo ""
    echo -e "${WHITE}GESTION DES SERVICES:${NC}"
    echo -e "${CYAN}  3)${NC} ğŸ”§ DÃ©marrer un service spÃ©cifique"
    echo -e "${CYAN}  4)${NC} â¹ï¸  ArrÃªter un service spÃ©cifique"
    echo -e "${CYAN}  5)${NC} ğŸ”„ RedÃ©marrer un service spÃ©cifique"
    echo -e "${CYAN}  6)${NC} ğŸ—ï¸  Builder/Rebuilder un service"
    echo ""
    echo -e "${WHITE}MONITORING & LOGS:${NC}"
    echo -e "${YELLOW}  7)${NC} ğŸ“Š Voir l'Ã©tat des containers"
    echo -e "${YELLOW}  8)${NC} ğŸ“ Voir les logs d'un service"
    echo -e "${YELLOW}  9)${NC} ğŸ“ˆ Suivre les logs en temps rÃ©el"
    echo -e "${YELLOW} 10)${NC} ğŸ–¥ï¸  Ouvrir un shell dans un container"
    echo -e "${YELLOW} 11)${NC} ğŸ–¥ï¸  Ouvrir terminaux de logs VS Code"
    echo ""
    echo -e "${WHITE}MAINTENANCE:${NC}"
    echo -e "${RED} 12)${NC} ğŸ›‘ ArrÃªter TOUS les services"
    echo -e "${RED} 13)${NC} ğŸ§¹ Options de nettoyage (soft/complet)"
    echo -e "${RED} 14)${NC} ğŸ”„ Restart complet (stop + build + start)"
    echo ""
    echo -e "${WHITE}UTILITAIRES:${NC}"
    echo -e "${BLUE} 15)${NC} ğŸ’¾ Backup de la base de donnÃ©es"
    echo -e "${BLUE} 16)${NC} ğŸ“¦ Voir l'utilisation des ressources"
    echo -e "${BLUE} 17)${NC} ğŸŒ Ouvrir les URLs de l'application"
    echo -e "${BLUE} 18)${NC} ğŸ” Diagnostic des services (debug)"
    echo -e "${GREEN} 19)${NC} ğŸ§ª Lancer les tests automatisÃ©s"
    echo ""
    echo -e "${WHITE} 0)${NC} âŒ Quitter"
    echo ""
    echo -e "${WHITE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
}

# Fonction pour sÃ©lectionner un service
select_service() {
    local prompt="$1"
    echo -e "\n${CYAN}$prompt${NC}" >&2
    echo "Services disponibles:" >&2
    for i in "${!SERVICES[@]}"; do
        echo "  $((i+1))) ${SERVICES[$i]}" >&2
    done
    echo "" >&2
    read -p "SÃ©lectionnez un service (numÃ©ro): " service_choice
    
    # VÃ©rifier si l'entrÃ©e est un nombre valide
    if [[ "$service_choice" =~ ^[0-9]+$ ]] && [[ $service_choice -ge 1 && $service_choice -le ${#SERVICES[@]} ]]; then
        echo "${SERVICES[$((service_choice-1))]}"
    else
        echo ""
    fi
}



# Fonction pour lancer automatiquement les tÃ¢ches VS Code de logs
launch_vscode_logs_task() {
    local environment="$1"
    local task_name=""
    
    if [[ "$environment" == "dÃ©veloppement" ]]; then
        task_name="ğŸš€ Ouvrir TOUS les Logs (DÃ©veloppement)"
    else
        task_name="ğŸ­ Ouvrir TOUS les Logs (Production)"
    fi
    
    echo -e "\n${CYAN}ğŸš€ Tentative de lancement automatique de la tÃ¢che VS Code...${NC}"
    
    # VÃ©rifier si la commande 'code' est disponible
    if command -v code &> /dev/null; then
        echo -e "${GREEN}âœ… VS Code CLI dÃ©tectÃ© !${NC}"
        
        # VÃ©rifier si VS Code est dÃ©jÃ  ouvert dans ce workspace
        local workspace_path="$(pwd)"
        
        # MÃ©thode 1: Essayer de lancer la tÃ¢che directement
        echo -e "${YELLOW}ğŸ¯ Tentative de lancement direct de la tÃ¢che...${NC}"
        
        # Utiliser une approche JSON pour dÃ©clencher la tÃ¢che
        local temp_script="/tmp/launch_vscode_task.sh"
        cat > "$temp_script" << EOF
#!/bin/bash
# Script temporaire pour lancer la tÃ¢che VS Code
echo "Lancement de la tÃ¢che VS Code: $task_name"
cd "$workspace_path"
code --command "workbench.action.tasks.runTask" --args "$task_name" . 2>/dev/null &
sleep 2
exit 0
EOF
        
        chmod +x "$temp_script"
        
        if "$temp_script" 2>/dev/null; then
            echo -e "${GREEN}âœ… Commande lancÃ©e !${NC}"
            echo -e "${CYAN}â¡ï¸  Si VS Code est ouvert, la tÃ¢che '${task_name}' devrait se lancer automatiquement${NC}"
            echo -e "${YELLOW}ğŸ“ Sinon, utilisez Ctrl+Shift+P dans VS Code et tapez le nom de la tÃ¢che${NC}"
            rm -f "$temp_script" 2>/dev/null
            return 0
        else
            echo -e "${YELLOW}âš ï¸  Lancement direct Ã©chouÃ©, ouverture de VS Code...${NC}"
            rm -f "$temp_script" 2>/dev/null
        fi
        
        # MÃ©thode 2: Ouvrir VS Code dans le workspace
        echo -e "${YELLOW}ğŸ“‚ Ouverture de VS Code dans le workspace...${NC}"
        
        if code "$workspace_path" 2>/dev/null; then
            echo -e "${GREEN}âœ… VS Code ouvert avec succÃ¨s !${NC}"
            echo -e "${CYAN}â¡ï¸  Dans VS Code:${NC}"
            echo -e "   1. Appuyez sur ${WHITE}Ctrl+Shift+P${NC}"
            echo -e "   2. Tapez: ${YELLOW}${task_name}${NC}"
            echo -e "   3. Appuyez sur ${WHITE}EntrÃ©e${NC}"
            echo -e "${GREEN}ğŸ‰ Tous les logs s'ouvriront automatiquement !${NC}"
            return 0
        else
            echo -e "${RED}âŒ Erreur lors de l'ouverture de VS Code${NC}"
            return 1
        fi
    else
        echo -e "${RED}âŒ VS Code CLI ('code') non trouvÃ© dans le PATH${NC}"
        echo -e "${YELLOW}ğŸ’¡ Pour installer VS Code CLI:${NC}"
        echo -e "   1. Ouvrez VS Code"
        echo -e "   2. ${WHITE}Ctrl+Shift+P${NC} â†’ tapez: ${CYAN}Shell Command: Install 'code' command in PATH${NC}"
        echo -e "   3. RedÃ©marrez votre terminal"
        echo -e "   4. Relancez ce script"
        return 1
    fi
}

# Fonction pour afficher les instructions manuelles de logs
show_manual_logs_instructions() {
    local environment="$1"
    
    echo -e "\n${CYAN}ğŸ–¥ï¸ Instructions manuelles pour logs en temps rÃ©el (${environment}):${NC}"
    echo -e "${GREEN}ğŸ“‹ OPTION RECOMMANDÃ‰E - TÃ¢ches VS Code manuelles:${NC}"
    echo ""
    echo -e "${WHITE}Dans VS Code:${NC}"
    echo -e "1. Appuyez sur ${GREEN}Ctrl+Shift+P${NC}"
    echo -e "2. Tapez: ${CYAN}Tasks: Run Task${NC}"
    
    if [[ "$environment" == "dÃ©veloppement" ]]; then
        echo -e "3. SÃ©lectionnez: ${YELLOW}ğŸš€ Ouvrir TOUS les Logs (DÃ©veloppement)${NC}"
        echo -e "4. ${GREEN}âœ… TERMINÃ‰ !${NC} Tous les logs s'ouvrent automatiquement dans des terminaux sÃ©parÃ©s"
        echo ""
        echo -e "${BLUE}ğŸ“‹ OU commandes manuelles Ã  copier-coller:${NC}"
        echo -e "${WHITE}# API Backend (${environment}):${NC}"
        echo -e "${CYAN}docker-compose logs -f api${NC}"
        echo ""
        echo -e "${WHITE}# Web Frontend (${environment}):${NC}"
        echo -e "${CYAN}docker-compose logs -f web${NC}"
        echo ""
        echo -e "${WHITE}# MongoDB Database (${environment}):${NC}"
        echo -e "${CYAN}docker-compose logs -f db${NC}"
        echo ""
        echo -e "${WHITE}# cAdvisor Monitoring (${environment}):${NC}"
        echo -e "${CYAN}docker-compose logs -f cadvisor${NC}"
        
        # Si c'est l'environnement de dÃ©veloppement et que mobile existe
        if docker-compose ps mobile 2>/dev/null | grep -q "Up"; then
            echo ""
            echo -e "${WHITE}# Mobile App (${environment}):${NC}"
            echo -e "${CYAN}docker-compose logs -f mobile${NC}"
        fi
    else
        echo -e "3. SÃ©lectionnez: ${YELLOW}ğŸ­ Ouvrir TOUS les Logs (Production)${NC}"
        echo -e "4. ${GREEN}âœ… TERMINÃ‰ !${NC} Tous les logs s'ouvrent automatiquement dans des terminaux sÃ©parÃ©s"
        echo ""
        echo -e "${BLUE}ğŸ“‹ OU commandes manuelles Ã  copier-coller:${NC}"
        echo -e "${WHITE}# API Backend (${environment}):${NC}"
        echo -e "${CYAN}docker-compose -f docker-compose.prod.yml logs -f api${NC}"
        echo ""
        echo -e "${WHITE}# Web Frontend (${environment}):${NC}"
        echo -e "${CYAN}docker-compose -f docker-compose.prod.yml logs -f web${NC}"
        echo ""
        echo -e "${WHITE}# MongoDB Database (${environment}):${NC}"
        echo -e "${CYAN}docker-compose -f docker-compose.prod.yml logs -f db${NC}"
        echo ""
        echo -e "${WHITE}# cAdvisor Monitoring (${environment}):${NC}"
        echo -e "${CYAN}docker-compose -f docker-compose.prod.yml logs -f cadvisor${NC}"
    fi
    
    echo ""
    echo -e "${YELLOW}ğŸ”§ Instructions pour ouvrir des terminaux VS Code:${NC}"
    echo -e "${WHITE}Si Ctrl+Shift+\` ne fonctionne pas, essayez ces alternatives:${NC}"
    echo -e "1. ${GREEN}Menu Terminal${NC} â†’ Nouveau Terminal"
    echo -e "2. ${GREEN}Ctrl+Shift+P${NC} â†’ tapez 'terminal new' â†’ EntrÃ©e"
    echo -e "3. ${GREEN}Bouton +${NC} dans le panneau terminal (en bas)"
    echo -e "4. ${GREEN}Ctrl+Shift+Ã¹${NC} (sur clavier franÃ§ais)"
    echo ""
    echo -e "${CYAN}ğŸ¯ Pour chaque service:${NC}"
    echo -e "â€¢ Ouvrez un nouveau terminal (mÃ©thode au choix ci-dessus)"
    echo -e "â€¢ Copiez-collez la commande du service"
    echo -e "â€¢ RÃ©pÃ©tez pour le service suivant"
    echo -e "â€¢ Utilisez ${WHITE}Ctrl+C${NC} pour arrÃªter les logs"
    echo ""
    echo -e "${GREEN}ğŸ’¡ Astuce: Renommez vos terminaux (clic droit â†’ Rename) avec le nom du service${NC}"
}

# Fonction pour afficher les instructions pour consulter les logs
show_logs_info() {
    local environment="$1"
    echo -e "\n${CYAN}ï¿½ Pour consulter les logs en ${environment}:${NC}"
    echo -e "${WHITE}â€¢ Utilisez les tÃ¢ches VS Code dans VS Code > Terminal > Run Task${NC}"
    echo -e "${GREEN}  - 'Open All Logs (Dev)' pour dÃ©veloppement${NC}"
    echo -e "${GREEN}  - 'Open All Logs (Prod)' pour production${NC}"
    echo -e "${WHITE}â€¢ Ou utilisez le menu option 11 du script Docker Manager${NC}"
}

# Fonction pour lancer l'environnement de dÃ©veloppement
start_development() {
    echo -e "\n${GREEN}ğŸš€ DÃ©marrage de l'environnement de DÃ‰VELOPPEMENT...${NC}"
    echo -e "${YELLOW}Mode: Hot reload activÃ© pour tous les services${NC}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    echo -e "\n${BLUE}Building images de dÃ©veloppement...${NC}"
    docker-compose build --no-cache
    
    echo -e "\n${BLUE}DÃ©marrage des services...${NC}"
    docker-compose up -d
    
    echo -e "\n${GREEN}âœ… Environnement de dÃ©veloppement dÃ©marrÃ© !${NC}"
    echo -e "${CYAN}ğŸ“ URLs disponibles:${NC}"
    echo "   â€¢ Web (Frontend): http://localhost:80"
    echo "   â€¢ API (Backend): http://localhost:3000"
    echo "   â€¢ MongoDB: localhost:27017"
    echo "   â€¢ cAdvisor (Monitoring): http://localhost:8080"
    
    # Afficher les informations sur les logs
    show_logs_info "dÃ©veloppement"
    
    # Menu post-dÃ©marrage
    while true; do
        echo ""
        echo -e "${WHITE}ğŸ¯ Services de dÃ©veloppement dÃ©marrÃ©s - Que voulez-vous faire ?${NC}"
        echo -e "${GREEN}  1)${NC} ğŸ“Š Voir l'Ã©tat des services"
        echo -e "${GREEN}  2)${NC} ğŸ“ Voir les logs d'un service"
        echo -e "${GREEN}  3)${NC} ğŸ–¥ï¸  Ouvrir les terminaux de logs VS Code"
        echo -e "${GREEN}  4)${NC} ğŸŒ Ouvrir les URLs de l'application"
        echo -e "${YELLOW}  5)${NC} ğŸ”„ RedÃ©marrer un service"
        echo -e "${RED}  6)${NC} ğŸ›‘ ArrÃªter TOUS les services de dÃ©veloppement"
        echo -e "${BLUE}  0)${NC} â¬…ï¸  Retour au menu principal"
        echo ""
        read -p "Votre choix: " post_choice
        
        case $post_choice in
            1)
                echo -e "\n${BLUE}ğŸ“Š Ã‰tat des services de dÃ©veloppement:${NC}"
                docker-compose ps
                pause
                ;;
            2)
                view_logs
                ;;
            3)
                # Rediriger vers le menu des logs VS Code (option 11)
                open_logs_terminals_menu
                ;;
            4)
                open_urls
                ;;
            5)
                restart_service
                ;;
            6)
                echo -e "\n${RED}ğŸ›‘ ArrÃªt des services de dÃ©veloppement...${NC}"
                docker-compose down
                echo -e "${GREEN}âœ… Services de dÃ©veloppement arrÃªtÃ©s !${NC}"
                pause
                return
                ;;
            0)
                echo -e "${BLUE}Retour au menu principal...${NC}"
                return
                ;;
            *)
                echo -e "${RED}âŒ Choix invalide. Veuillez rÃ©essayer.${NC}"
                ;;
        esac
    done
}

# Fonction pour lancer l'environnement de production
start_production() {
    echo -e "\n${PURPLE}ğŸ­ DÃ©marrage de l'environnement de PRODUCTION...${NC}"
    echo -e "${YELLOW}Mode: Images optimisÃ©es + Health checks${NC}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    echo -e "\n${BLUE}Building images de production...${NC}"
    docker-compose -f docker-compose.prod.yml build --no-cache
    
    echo -e "\n${BLUE}DÃ©marrage des services...${NC}"
    docker-compose -f docker-compose.prod.yml up -d
    
    echo -e "\n${GREEN}âœ… Environnement de production dÃ©marrÃ© !${NC}"
    echo -e "${CYAN}ğŸ“ URLs disponibles:${NC}"
    echo "   â€¢ Web (Frontend): http://localhost:80"
    echo "   â€¢ API (Backend): http://localhost:3000"
    echo "   â€¢ MongoDB: localhost:27017"
    echo "   â€¢ cAdvisor (Monitoring): http://localhost:8080"
    
    # Afficher les informations sur les logs
    show_logs_info "production"
    
    # Menu post-dÃ©marrage
    while true; do
        echo ""
        echo -e "${WHITE}ğŸ¯ Services de production dÃ©marrÃ©s - Que voulez-vous faire ?${NC}"
        echo -e "${GREEN}  1)${NC} ğŸ“Š Voir l'Ã©tat des services"
        echo -e "${GREEN}  2)${NC} ğŸ“ Voir les logs d'un service"
        echo -e "${GREEN}  3)${NC} ğŸ–¥ï¸  Ouvrir les terminaux de logs VS Code"
        echo -e "${GREEN}  4)${NC} ğŸŒ Ouvrir les URLs de l'application"
        echo -e "${GREEN}  5)${NC} ğŸ“¦ Voir l'utilisation des ressources"
        echo -e "${YELLOW}  6)${NC} ğŸ”„ RedÃ©marrer un service"
        echo -e "${YELLOW}  7)${NC} ğŸ’¾ Backup de la base de donnÃ©es"
        echo -e "${RED}  8)${NC} ğŸ›‘ ArrÃªter TOUS les services de production"
        echo -e "${BLUE}  0)${NC} â¬…ï¸  Retour au menu principal"
        echo ""
        read -p "Votre choix: " post_choice
        
        case $post_choice in
            1)
                echo -e "\n${BLUE}ğŸ“Š Ã‰tat des services de production:${NC}"
                docker-compose -f docker-compose.prod.yml ps
                pause
                ;;
            2)
                # Adapter view_logs pour la production
                service=$(select_service "De quel service voulez-vous voir les logs (production) ?")
                if [[ -n "$service" ]]; then
                    echo -e "\n${YELLOW}ğŸ“ Logs du service: $service (production)${NC}"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo -e "${CYAN}Affichage des 50 derniÃ¨res lignes de logs...${NC}"
                    if docker-compose -f docker-compose.prod.yml logs --tail=50 "$service"; then
                        echo -e "\n${GREEN}âœ… Logs affichÃ©s avec succÃ¨s${NC}"
                    else
                        echo -e "\n${RED}âŒ Erreur lors de l'affichage des logs pour le service $service${NC}"
                    fi
                else
                    echo -e "${RED}âŒ Service invalide.${NC}"
                fi
                pause
                ;;
            3)
                # Rediriger vers le menu des logs VS Code (option 11)
                open_logs_terminals_menu
                ;;
            4)
                open_urls
                ;;
            5)
                show_resources
                ;;
            6)
                # Adapter restart_service pour la production
                service=$(select_service "Quel service voulez-vous redÃ©marrer (production) ?")
                if [[ -n "$service" ]]; then
                    echo -e "\n${YELLOW}ğŸ”„ RedÃ©marrage du service: $service (production)${NC}"
                    if docker-compose -f docker-compose.prod.yml restart "$service"; then
                        echo -e "${GREEN}âœ… Service $service redÃ©marrÃ© !${NC}"
                    else
                        echo -e "${RED}âŒ Erreur lors du redÃ©marrage du service $service${NC}"
                    fi
                else
                    echo -e "${RED}âŒ Service invalide.${NC}"
                fi
                pause
                ;;
            7)
                # Adapter backup pour la production
                echo -e "\n${BLUE}ğŸ’¾ Backup de la base de donnÃ©es MongoDB (production)...${NC}"
                if docker-compose -f docker-compose.prod.yml ps db | grep -q "Up"; then
                    backup_dir="./backups"
                    mkdir -p "$backup_dir"
                    
                    timestamp=$(date +"%Y%m%d_%H%M%S")
                    backup_file="$backup_dir/mongodb_backup_prod_$timestamp"
                    
                    echo "ğŸ“¦ CrÃ©ation du backup..."
                    docker-compose -f docker-compose.prod.yml exec -T db mongodump --out /tmp/backup
                    docker-compose -f docker-compose.prod.yml exec -T db tar -czf "/tmp/backup_$timestamp.tar.gz" -C /tmp backup
                    docker cp "$(docker-compose -f docker-compose.prod.yml ps -q db):/tmp/backup_$timestamp.tar.gz" "$backup_file.tar.gz"
                    
                    echo -e "${GREEN}âœ… Backup crÃ©Ã©: $backup_file.tar.gz${NC}"
                else
                    echo -e "${RED}âŒ Le container de base de donnÃ©es n'est pas en cours d'exÃ©cution${NC}"
                fi
                pause
                ;;
            8)
                echo -e "\n${RED}ğŸ›‘ ArrÃªt des services de production...${NC}"
                docker-compose -f docker-compose.prod.yml down
                echo -e "${GREEN}âœ… Services de production arrÃªtÃ©s !${NC}"
                pause
                return
                ;;
            0)
                echo -e "${BLUE}Retour au menu principal...${NC}"
                return
                ;;
            *)
                echo -e "${RED}âŒ Choix invalide. Veuillez rÃ©essayer.${NC}"
                ;;
        esac
    done
}

# Menu post-dÃ©marrage pour l'environnement de dÃ©veloppement
post_start_menu() {
    local env_name="$1"
    
    while true; do
        echo ""
        echo -e "${WHITE}ğŸ¯ Services de ${env_name} dÃ©marrÃ©s - Que voulez-vous faire ?${NC}"
        echo -e "${GREEN}  1)${NC} ğŸ“Š Voir l'Ã©tat des services"
        echo -e "${GREEN}  2)${NC} ğŸ“ Voir les logs d'un service"
        echo -e "${GREEN}  3)${NC} ğŸ–¥ï¸  Ouvrir les terminaux de logs VS Code"
        echo -e "${GREEN}  4)${NC} ğŸŒ Ouvrir les URLs de l'application"
        echo -e "${YELLOW}  5)${NC} ğŸ”„ RedÃ©marrer un service"
        echo -e "${RED}  6)${NC} ğŸ›‘ ArrÃªter TOUS les services de ${env_name}"
        echo -e "${BLUE}  0)${NC} â¬…ï¸  Retour au menu principal"
        echo ""
        read -p "Votre choix: " post_choice
        
        case $post_choice in
            1)
                echo -e "\n${BLUE}ğŸ“Š Ã‰tat des services de ${env_name}:${NC}"
                docker-compose ps
                pause
                ;;
            2)
                view_logs
                ;;
            3)
                # Rediriger vers le menu des logs VS Code (option 11)
                open_logs_terminals_menu
                ;;
            4)
                open_urls
                ;;
            5)
                restart_service
                ;;
            6)
                echo -e "\n${RED}ğŸ›‘ ArrÃªt des services de ${env_name}...${NC}"
                docker-compose down
                echo -e "${GREEN}âœ… Services de ${env_name} arrÃªtÃ©s !${NC}"
                pause
                return
                ;;
            0)
                echo -e "${BLUE}Retour au menu principal...${NC}"
                return
                ;;
            *)
                echo -e "${RED}âŒ Choix invalide. Veuillez rÃ©essayer.${NC}"
                ;;
        esac
    done
}

# Menu post-dÃ©marrage pour l'environnement de production
post_start_menu_prod() {
    local env_name="$1"
    
    while true; do
        echo ""
        echo -e "${WHITE}ğŸ­ Services de ${env_name} dÃ©marrÃ©s - Que voulez-vous faire ?${NC}"
        echo -e "${GREEN}  1)${NC} ğŸ“Š Voir l'Ã©tat des services"
        echo -e "${GREEN}  2)${NC} ğŸ“ Voir les logs d'un service"
        echo -e "${GREEN}  3)${NC} ğŸ–¥ï¸  Ouvrir les terminaux de logs VS Code"
        echo -e "${GREEN}  4)${NC} ğŸŒ Ouvrir les URLs de l'application"
        echo -e "${GREEN}  5)${NC} ğŸ“Š Monitorer les ressources"
        echo -e "${YELLOW}  6)${NC} ğŸ”„ RedÃ©marrer un service"
        echo -e "${YELLOW}  7)${NC} ğŸ’¾ Backup base de donnÃ©es"
        echo -e "${RED}  8)${NC} ğŸ›‘ ArrÃªter TOUS les services de ${env_name}"
        echo -e "${BLUE}  0)${NC} â¬…ï¸  Retour au menu principal"
        echo ""
        read -p "Votre choix: " post_choice
        
        case $post_choice in
            1)
                echo -e "\n${BLUE}ğŸ“Š Ã‰tat des services de ${env_name}:${NC}"
                docker-compose -f docker-compose.prod.yml ps
                pause
                ;;
            2)
                # Adapter view_logs pour la production
                service=$(select_service "Pour quel service voulez-vous voir les logs (production) ?")
                if [[ -n "$service" ]]; then
                    echo -e "\n${CYAN}ğŸ“‹ Logs du service: $service (production)${NC}"
                    echo -e "${CYAN}Affichage des 50 derniÃ¨res lignes de logs...${NC}"
                    if docker-compose -f docker-compose.prod.yml logs --tail=50 "$service"; then
                        echo -e "\n${GREEN}âœ… Logs affichÃ©s avec succÃ¨s${NC}"
                    else
                        echo -e "\n${RED}âŒ Erreur lors de l'affichage des logs pour le service $service${NC}"
                    fi
                else
                    echo -e "${RED}âŒ Service invalide.${NC}"
                fi
                pause
                ;;
            3)
                # Rediriger vers le menu des logs VS Code (option 11)
                open_logs_terminals_menu
                ;;
            4)
                open_urls
                ;;
            5)
                show_resources
                ;;
            6)
                # Adapter restart_service pour la production
                service=$(select_service "Quel service voulez-vous redÃ©marrer (production) ?")
                if [[ -n "$service" ]]; then
                    echo -e "\n${YELLOW}ğŸ”„ RedÃ©marrage du service: $service (production)${NC}"
                    if docker-compose -f docker-compose.prod.yml restart "$service"; then
                        echo -e "${GREEN}âœ… Service $service redÃ©marrÃ© !${NC}"
                    else
                        echo -e "${RED}âŒ Erreur lors du redÃ©marrage du service $service${NC}"
                    fi
                else
                    echo -e "${RED}âŒ Service invalide.${NC}"
                fi
                pause
                ;;
            7)
                # Adapter backup pour la production
                echo -e "\n${BLUE}ğŸ’¾ Backup de la base de donnÃ©es MongoDB (production)...${NC}"
                if docker-compose -f docker-compose.prod.yml ps db | grep -q "Up"; then
                    backup_dir="./backups"
                    mkdir -p "$backup_dir"
                    
                    timestamp=$(date +"%Y%m%d_%H%M%S")
                    backup_file="$backup_dir/mongodb_backup_prod_$timestamp"
                    
                    echo "ğŸ“¦ CrÃ©ation du backup..."
                    docker-compose -f docker-compose.prod.yml exec -T db mongodump --out /tmp/backup
                    docker-compose -f docker-compose.prod.yml exec -T db tar -czf "/tmp/backup_$timestamp.tar.gz" -C /tmp backup
                    docker cp "$(docker-compose -f docker-compose.prod.yml ps -q db):/tmp/backup_$timestamp.tar.gz" "$backup_file.tar.gz"
                    
                    echo -e "${GREEN}âœ… Backup crÃ©Ã©: $backup_file.tar.gz${NC}"
                else
                    echo -e "${RED}âŒ Le container de base de donnÃ©es n'est pas en cours d'exÃ©cution${NC}"
                fi
                pause
                ;;
            8)
                echo -e "\n${RED}ğŸ›‘ ArrÃªt des services de ${env_name}...${NC}"
                docker-compose -f docker-compose.prod.yml down
                echo -e "${GREEN}âœ… Services de ${env_name} arrÃªtÃ©s !${NC}"
                pause
                return
                ;;
            0)
                echo -e "${BLUE}Retour au menu principal...${NC}"
                return
                ;;
            *)
                echo -e "${RED}âŒ Choix invalide. Veuillez rÃ©essayer.${NC}"
                ;;
        esac
    done
}

# Fonction pour dÃ©marrage rapide dÃ©veloppement (sans rebuild)
quick_start_development() {
    echo -e "\n${CYAN}âš¡ DÃ‰MARRAGE RAPIDE - Environnement de dÃ©veloppement${NC}"
    echo -e "${YELLOW}Mode: Containers existants (aucun rebuild)${NC}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    echo -e "\n${BLUE}ğŸš€ DÃ©marrage des containers...${NC}"
    if docker-compose up -d; then
        echo -e "${GREEN}âœ… Environnement de dÃ©veloppement dÃ©marrÃ© rapidement !${NC}"
        
        echo -e "\n${CYAN}ğŸ“‹ Ã‰tat des services:${NC}"
        docker-compose ps
        
        echo -e "\n${CYAN}ğŸŒ Applications disponibles:${NC}"
        echo "   â€¢ Frontend Web: http://localhost:80"
        echo "   â€¢ API Backend: http://localhost:3000"
        echo "   â€¢ MongoDB: mongodb://localhost:27017"
        
        # Menu post-dÃ©marrage
        post_start_menu "dÃ©veloppement"
    else
        echo -e "${RED}âŒ Erreur lors du dÃ©marrage rapide${NC}"
        echo -e "${YELLOW}ğŸ’¡ Conseil: Utilisez l'option 1 (dÃ©marrage complet) si les images n'existent pas${NC}"
        pause
    fi
}

# Fonction pour dÃ©marrage rapide production (sans rebuild)
quick_start_production() {
    echo -e "\n${PURPLE}âš¡ DÃ‰MARRAGE RAPIDE - Environnement de production${NC}"
    echo -e "${YELLOW}Mode: Containers existants (aucun rebuild)${NC}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    echo -e "\n${BLUE}ğŸš€ DÃ©marrage des containers de production...${NC}"
    if docker-compose -f docker-compose.prod.yml up -d; then
        echo -e "${GREEN}âœ… Environnement de production dÃ©marrÃ© rapidement !${NC}"
        
        echo -e "\n${CYAN}ğŸ“‹ Ã‰tat des services:${NC}"
        docker-compose -f docker-compose.prod.yml ps
        
        echo -e "\n${CYAN}ğŸŒ Applications disponibles:${NC}"
        echo "   â€¢ Frontend Web: http://localhost:80"
        echo "   â€¢ API Backend: http://localhost:3000"
        echo "   â€¢ MongoDB: mongodb://localhost:27017"
        
        # Menu post-dÃ©marrage
        post_start_menu_prod "production"
    else
        echo -e "${RED}âŒ Erreur lors du dÃ©marrage rapide${NC}"
        echo -e "${YELLOW}ğŸ’¡ Conseil: Utilisez l'option 2 (dÃ©marrage complet) si les images n'existent pas${NC}"
        pause
    fi
}

# Fonction pour dÃ©marrage rapide tests (sans rebuild)
quick_start_tests() {
    echo -e "\n${GREEN}âš¡ DÃ‰MARRAGE RAPIDE - Environnement de tests${NC}"
    echo -e "${YELLOW}Mode: Containers existants (aucun rebuild)${NC}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    echo -e "\n${BLUE}ğŸš€ DÃ©marrage des containers de test...${NC}"
    if docker-compose -f docker-compose.test.yml up -d; then
        echo -e "${GREEN}âœ… Environnement de test dÃ©marrÃ© rapidement !${NC}"
        
        echo -e "\n${CYAN}ğŸ“‹ Ã‰tat des services:${NC}"
        docker-compose -f docker-compose.test.yml ps
        
        echo -e "\n${CYAN}ğŸ’¡ PrÃªt pour exÃ©cuter des tests:${NC}"
        echo "   â€¢ Tests API: Option 19 du menu principal"
        echo "   â€¢ Tests manuels: docker-compose -f docker-compose.test.yml exec api npm test"
        
        echo -e "\n${YELLOW}ğŸ›‘ N'oubliez pas d'arrÃªter l'environnement aprÃ¨s les tests !${NC}"
        echo "   Commande: docker-compose -f docker-compose.test.yml down"
        
        pause
    else
        echo -e "${RED}âŒ Erreur lors du dÃ©marrage rapide${NC}"
        echo -e "${YELLOW}ğŸ’¡ Conseil: Utilisez l'option 19 (tests complets) si les images n'existent pas${NC}"
        pause
    fi
}

# Fonction pour dÃ©marrer un service spÃ©cifique
start_service() {
    service=$(select_service "Quel service voulez-vous dÃ©marrer ?")
    if [[ -n "$service" ]]; then
        echo -e "\n${GREEN}ğŸ”§ DÃ©marrage du service: $service${NC}"
        if docker-compose up -d "$service"; then
            echo -e "${GREEN}âœ… Service $service dÃ©marrÃ© !${NC}"
        else
            echo -e "${RED}âŒ Erreur lors du dÃ©marrage du service $service${NC}"
        fi
    else
        echo -e "${RED}âŒ Service invalide. Veuillez choisir un numÃ©ro entre 1 et ${#SERVICES[@]}.${NC}"
    fi
    pause
}

# Fonction pour arrÃªter un service spÃ©cifique
stop_service() {
    service=$(select_service "Quel service voulez-vous arrÃªter ?")
    if [[ -n "$service" ]]; then
        echo -e "\n${RED}â¹ï¸ ArrÃªt du service: $service${NC}"
        if docker-compose stop "$service"; then
            echo -e "${GREEN}âœ… Service $service arrÃªtÃ© !${NC}"
        else
            echo -e "${RED}âŒ Erreur lors de l'arrÃªt du service $service${NC}"
        fi
    else
        echo -e "${RED}âŒ Service invalide. Veuillez choisir un numÃ©ro entre 1 et ${#SERVICES[@]}.${NC}"
    fi
    pause
}

# Fonction pour redÃ©marrer un service spÃ©cifique
restart_service() {
    service=$(select_service "Quel service voulez-vous redÃ©marrer ?")
    if [[ -n "$service" ]]; then
        echo -e "\n${YELLOW}ğŸ”„ RedÃ©marrage du service: $service${NC}"
        if docker-compose restart "$service"; then
            echo -e "${GREEN}âœ… Service $service redÃ©marrÃ© !${NC}"
        else
            echo -e "${RED}âŒ Erreur lors du redÃ©marrage du service $service${NC}"
        fi
    else
        echo -e "${RED}âŒ Service invalide. Veuillez choisir un numÃ©ro entre 1 et ${#SERVICES[@]}.${NC}"
    fi
    pause
}

# Fonction pour builder un service
build_service() {
    service=$(select_service "Quel service voulez-vous builder ?")
    if [[ -n "$service" ]]; then
        echo -e "\n${BLUE}ğŸ—ï¸ Building du service: $service${NC}"
        echo "Choisissez le mode:"
        echo "  1) DÃ©veloppement (Dockerfile.dev)"
        echo "  2) Production (Dockerfile)"
        read -p "Mode (1-2): " mode_choice
        
        if [[ "$mode_choice" == "1" ]]; then
            docker-compose build --no-cache "$service"
            echo -e "${GREEN}âœ… Service $service buildÃ© en mode dÃ©veloppement !${NC}"
        elif [[ "$mode_choice" == "2" ]]; then
            docker-compose -f docker-compose.prod.yml build --no-cache "$service"
            echo -e "${GREEN}âœ… Service $service buildÃ© en mode production !${NC}"
        else
            echo -e "${RED}âŒ Mode invalide${NC}"
        fi
    else
        echo -e "${RED}âŒ Service invalide${NC}"
    fi
    pause
}

# Fonction pour voir les logs d'un service
view_logs() {
    service=$(select_service "De quel service voulez-vous voir les logs ?")
    if [[ -n "$service" ]]; then
        echo -e "\n${YELLOW}ğŸ“ Logs du service: $service${NC}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo -e "${CYAN}Affichage des 50 derniÃ¨res lignes de logs...${NC}"
        if docker-compose logs --tail=50 "$service"; then
            echo -e "\n${GREEN}âœ… Logs affichÃ©s avec succÃ¨s${NC}"
        else
            echo -e "\n${RED}âŒ Erreur lors de l'affichage des logs pour le service $service${NC}"
        fi
    else
        echo -e "${RED}âŒ Service invalide. Veuillez choisir un numÃ©ro entre 1 et ${#SERVICES[@]}.${NC}"
    fi
    pause
}

# Fonction pour suivre les logs en temps rÃ©el
follow_logs() {
    service=$(select_service "De quel service voulez-vous suivre les logs ?")
    if [[ -n "$service" ]]; then
        echo -e "\n${YELLOW}ğŸ“ˆ Logs en temps rÃ©el du service: $service${NC}"
        echo -e "${CYAN}Appuyez sur Ctrl+C pour arrÃªter${NC}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        if docker-compose logs -f "$service"; then
            echo -e "\n${GREEN}âœ… Suivi des logs terminÃ©${NC}"
        else
            echo -e "\n${RED}âŒ Erreur lors du suivi des logs pour le service $service${NC}"
        fi
    else
        echo -e "${RED}âŒ Service invalide. Veuillez choisir un numÃ©ro entre 1 et ${#SERVICES[@]}.${NC}"
    fi
    pause
}

# Fonction pour ouvrir les terminaux de logs depuis le menu
open_logs_terminals_menu() {
    echo -e "\n${CYAN}ğŸ–¥ï¸ Ouverture des terminaux de logs...${NC}"
    echo "Quel environnement utilisez-vous ?"
    echo "  1) DÃ©veloppement (docker-compose.yml)"
    echo "  2) Production (docker-compose.prod.yml)"
    echo "  3) Test (docker-compose.test.yml)"
    read -p "Environnement (1-3): " env_choice
    
    case $env_choice in
        1)
            # VÃ©rifier que les services de dÃ©veloppement sont actifs
            if docker-compose ps | grep -q "Up"; then
                open_logs_terminals "dÃ©veloppement"
            else
                echo -e "${RED}âŒ Aucun service de dÃ©veloppement en cours d'exÃ©cution${NC}"
                echo -e "${YELLOW}ğŸ’¡ Lancez d'abord l'environnement de dÃ©veloppement (option 1)${NC}"
            fi
            ;;
        2)
            # VÃ©rifier que les services de production sont actifs
            if docker-compose -f docker-compose.prod.yml ps | grep -q "Up"; then
                open_logs_terminals_prod "production"
            else
                echo -e "${RED}âŒ Aucun service de production en cours d'exÃ©cution${NC}"
                echo -e "${YELLOW}ğŸ’¡ Lancez d'abord l'environnement de production (option 2)${NC}"
            fi
            ;;
        3)
            # VÃ©rifier que les services de test sont actifs
            if docker-compose -f docker-compose.test.yml ps | grep -q "Up"; then
                echo -e "\n${CYAN}ğŸ–¥ï¸ Commandes pour logs des tests:${NC}"
                echo -e "${WHITE}# API Backend (test):${NC}"
                echo -e "${CYAN}docker-compose -f docker-compose.test.yml logs -f api${NC}"
                echo ""
                echo -e "${WHITE}# MongoDB Test Database:${NC}"
                echo -e "${CYAN}docker-compose -f docker-compose.test.yml logs -f db-test${NC}"
            else
                echo -e "${RED}âŒ Aucun service de test en cours d'exÃ©cution${NC}"
                echo -e "${YELLOW}ğŸ’¡ Lancez d'abord les tests (option 19)${NC}"
            fi
            ;;
        *)
            echo -e "${RED}âŒ Choix invalide${NC}"
            ;;
    esac
    pause
}

# Fonction pour ouvrir un shell dans un container
open_shell() {
    service=$(select_service "Dans quel container voulez-vous ouvrir un shell ?")
    if [[ -n "$service" ]]; then
        echo -e "\n${CYAN}ğŸ–¥ï¸ Ouverture d'un shell dans: $service${NC}"
        
        # VÃ©rifier si le container est en cours d'exÃ©cution
        if docker-compose ps "$service" | grep -q "Up"; then
            case "$service" in
                "web"|"api"|"mobile")
                    docker-compose exec "$service" /bin/sh
                    ;;
                "db")
                    echo "Choix disponibles:"
                    echo "  1) Shell bash/sh"
                    echo "  2) MongoDB shell (mongosh)"
                    read -p "Votre choix (1-2): " shell_choice
                    if [[ "$shell_choice" == "1" ]]; then
                        docker-compose exec "$service" /bin/bash
                    elif [[ "$shell_choice" == "2" ]]; then
                        docker-compose exec "$service" mongosh
                    fi
                    ;;
                *)
                    docker-compose exec "$service" /bin/sh
                    ;;
            esac
        else
            echo -e "${RED}âŒ Le container $service n'est pas en cours d'exÃ©cution${NC}"
            pause
        fi
    else
        echo -e "${RED}âŒ Service invalide${NC}"
        pause
    fi
}

# Fonction pour arrÃªter tous les services
stop_all() {
    echo -e "\n${RED}ğŸ›‘ ArrÃªt de TOUS les services...${NC}"
    docker-compose down
    docker-compose -f docker-compose.prod.yml down
    echo -e "${GREEN}âœ… Tous les services arrÃªtÃ©s !${NC}"
    pause
}

# Fonction de nettoyage complet
cleanup() {
    echo -e "\n${RED}ğŸ§¹ Options de nettoyage du projet...${NC}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${WHITE}Choisissez le type de nettoyage :${NC}"
    echo -e "${YELLOW}  1)${NC} ğŸ”„ Nettoyage SOFT (containers + images, GARDE les volumes)"
    echo -e "${RED}  2)${NC} ğŸ’¥ Nettoyage COMPLET (containers + images + volumes - PERTE DE DONNÃ‰ES)"
    echo -e "${CYAN}  3)${NC} ğŸ“Š Voir ce qui sera supprimÃ©"
    echo -e "${WHITE}  0)${NC} âŒ Annuler"
    echo ""
    read -p "Votre choix (0-3): " cleanup_choice
    
    case $cleanup_choice in
        1)
            echo -e "\n${YELLOW}ğŸ”„ Nettoyage SOFT (prÃ©servation des donnÃ©es)...${NC}"
            echo -e "${GREEN}âœ… Les volumes (base de donnÃ©es) seront PRÃ‰SERVÃ‰S${NC}"
            read -p "Continuer ? (y/N): " confirm
            
            if [[ "$confirm" =~ ^[Yy]$ ]]; then
                echo "ğŸ›‘ ArrÃªt des services..."
                docker-compose down
                docker-compose -f docker-compose.prod.yml down
                
                echo "ğŸ—‘ï¸ Suppression des images..."
                docker images | grep "$PROJECT_NAME" | awk '{print $3}' | xargs -r docker rmi -f
                
                echo "ğŸ§½ Nettoyage des ressources non utilisÃ©es..."
                docker system prune -f
                
                echo -e "${GREEN}âœ… Nettoyage SOFT terminÃ© ! DonnÃ©es prÃ©servÃ©es.${NC}"
            else
                echo -e "${YELLOW}Nettoyage annulÃ©${NC}"
            fi
            ;;
        2)
            echo -e "\n${RED}ğŸ’¥ Nettoyage COMPLET (DESTRUCTEUR)...${NC}"
            echo -e "${RED}âš ï¸  ATTENTION: Cela va supprimer:${NC}"
            echo "   â€¢ Tous les containers"
            echo "   â€¢ Toutes les images du projet"
            echo -e "${RED}   â€¢ TOUS LES VOLUMES (base de donnÃ©es MongoDB)${NC}"
            echo -e "${RED}   â€¢ TOUS LES FICHIERS STOCKÃ‰S${NC}"
            echo ""
            echo -e "${YELLOW}ğŸ’¡ Conseil: Utilisez l'option 14 (Backup) avant ce nettoyage${NC}"
            echo ""
            read -p "ÃŠtes-vous VRAIMENT sÃ»r ? Tapez 'DELETE' pour confirmer: " confirm
            
            if [[ "$confirm" == "DELETE" ]]; then
                echo "ğŸ›‘ ArrÃªt des services..."
                docker-compose down -v
                docker-compose -f docker-compose.prod.yml down -v
                
                echo "ğŸ—‘ï¸ Suppression des images..."
                docker images | grep "$PROJECT_NAME" | awk '{print $3}' | xargs -r docker rmi -f
                
                echo "ğŸ§½ Nettoyage des ressources non utilisÃ©es..."
                docker system prune -f
                
                echo -e "${GREEN}âœ… Nettoyage COMPLET terminÃ© ! Toutes les donnÃ©es supprimÃ©es.${NC}"
            else
                echo -e "${YELLOW}Nettoyage COMPLET annulÃ© (bonne dÃ©cision !)${NC}"
            fi
            ;;
        3)
            echo -e "\n${CYAN}ğŸ“Š Analyse de ce qui serait supprimÃ©...${NC}"
            echo ""
            echo -e "${BLUE}ğŸ³ Containers en cours:${NC}"
            docker-compose ps
            echo ""
            echo -e "${BLUE}ğŸ–¼ï¸ Images du projet:${NC}"
            docker images | grep "$PROJECT_NAME" || echo "Aucune image trouvÃ©e"
            echo ""
            echo -e "${BLUE}ğŸ’¾ Volumes du projet:${NC}"
            docker volume ls | grep "$PROJECT_NAME" || echo "Aucun volume nommÃ© trouvÃ©"
            docker-compose config --volumes 2>/dev/null || echo "Utilisation des volumes dÃ©finis dans docker-compose.yml"
            echo ""
            echo -e "${YELLOW}ğŸ’¡ Volumes principaux:${NC}"
            echo "   â€¢ mongo-data (base de donnÃ©es MongoDB)"
            echo "   â€¢ Volumes de dÃ©veloppement (code mappÃ©)"
            ;;
        0|*)
            echo -e "${YELLOW}Nettoyage annulÃ©${NC}"
            ;;
    esac
    pause
}

# Fonction de restart complet
full_restart() {
    echo -e "\n${YELLOW}ğŸ”„ Restart complet du projet...${NC}"
    echo "Choisissez l'environnement:"
    echo "  1) DÃ©veloppement"
    echo "  2) Production"
    read -p "Environnement (1-2): " env_choice
    
    echo "ğŸ›‘ ArrÃªt des services..."
    stop_all
    
    if [[ "$env_choice" == "1" ]]; then
        start_development
    elif [[ "$env_choice" == "2" ]]; then
        start_production
    else
        echo -e "${RED}âŒ Choix invalide${NC}"
        pause
    fi
}

# Fonction de backup de la base de donnÃ©es
backup_database() {
    echo -e "\n${BLUE}ğŸ’¾ Backup de la base de donnÃ©es MongoDB...${NC}"
    
    # VÃ©rifier si le container db est en cours d'exÃ©cution
    if docker-compose ps db | grep -q "Up"; then
        backup_dir="./backups"
        mkdir -p "$backup_dir"
        
        timestamp=$(date +"%Y%m%d_%H%M%S")
        backup_file="$backup_dir/mongodb_backup_$timestamp"
        
        echo "ğŸ“¦ CrÃ©ation du backup..."
        docker-compose exec -T db mongodump --out /tmp/backup
        docker-compose exec -T db tar -czf "/tmp/backup_$timestamp.tar.gz" -C /tmp backup
        docker cp "$(docker-compose ps -q db):/tmp/backup_$timestamp.tar.gz" "$backup_file.tar.gz"
        
        echo -e "${GREEN}âœ… Backup crÃ©Ã©: $backup_file.tar.gz${NC}"
    else
        echo -e "${RED}âŒ Le container de base de donnÃ©es n'est pas en cours d'exÃ©cution${NC}"
    fi
    pause
}

# Fonction pour voir l'utilisation des ressources
show_resources() {
    echo -e "\n${BLUE}ğŸ“¦ Utilisation des ressources Docker:${NC}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    echo -e "\n${CYAN}ğŸ’¾ Utilisation du disque:${NC}"
    docker system df
    
    echo -e "\n${CYAN}ğŸ–¥ï¸ Ressources des containers:${NC}"
    docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}"
    
    pause
}

# Fonction pour ouvrir les URLs de l'application
open_urls() {
    echo -e "\n${BLUE}ğŸŒ URLs de l'application SUPCHAT:${NC}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${GREEN}Frontend (Web):${NC}     http://localhost:80"
    echo -e "${GREEN}API (Backend):${NC}      http://localhost:3000"
    echo -e "${GREEN}API Health:${NC}         http://localhost:3000/api/health"
    echo -e "${GREEN}API Docs (Swagger):${NC} http://localhost:3000/api-docs"
    echo -e "${GREEN}MongoDB:${NC}            localhost:27017"
    echo -e "${GREEN}cAdvisor:${NC}           http://localhost:8080"
    echo ""
    
    read -p "Voulez-vous ouvrir une URL dans le navigateur ? (y/N): " open_browser
    if [[ "$open_browser" =~ ^[Yy]$ ]]; then
        echo "Quelle URL voulez-vous ouvrir ?"
        echo "  1) Frontend (Web)"
        echo "  2) API Health Check"
        echo "  3) API Documentation"
        echo "  4) cAdvisor (Monitoring)"
        read -p "Choix (1-4): " url_choice
        
        case "$url_choice" in
            1) xdg-open "http://localhost:80" 2>/dev/null || open "http://localhost:80" 2>/dev/null || start "http://localhost:80" 2>/dev/null ;;
            2) xdg-open "http://localhost:3000/api/health" 2>/dev/null || open "http://localhost:3000/api/health" 2>/dev/null || start "http://localhost:3000/api/health" 2>/dev/null ;;
            3) xdg-open "http://localhost:3000/api-docs" 2>/dev/null || open "http://localhost:3000/api-docs" 2>/dev/null || start "http://localhost:3000/api-docs" 2>/dev/null ;;
            4) xdg-open "http://localhost:8080" 2>/dev/null || open "http://localhost:8080" 2>/dev/null || start "http://localhost:8080" 2>/dev/null ;;
            *) echo -e "${RED}âŒ Choix invalide${NC}" ;;
        esac
    fi
    pause
}

# Fonction de diagnostic des services
diagnostic_services() {
    echo -e "\n${BLUE}ğŸ” Diagnostic des services Docker...${NC}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    echo -e "\n${CYAN}ğŸ“‹ Services configurÃ©s dans le script:${NC}"
    for i in "${!SERVICES[@]}"; do
        echo "  $((i+1))) ${SERVICES[$i]}"
    done
    
    echo -e "\n${CYAN}ğŸ³ Ã‰tat dÃ©taillÃ© des containers:${NC}"
    docker-compose ps -a
    
    echo -e "\n${CYAN}ğŸ”— Services dans docker-compose.yml:${NC}"
    docker-compose config --services 2>/dev/null || echo "Erreur lors de la lecture de docker-compose.yml"
    
    echo -e "\n${CYAN}ğŸ“Š Test de connectivitÃ© aux services:${NC}"
    for service in "${SERVICES[@]}"; do
        echo -n "  â€¢ $service: "
        if docker-compose ps "$service" | grep -q "Up"; then
            echo -e "${GREEN}âœ… En fonctionnement${NC}"
            echo "    Logs rÃ©cents:"
            docker-compose logs --tail=3 "$service" 2>/dev/null | sed 's/^/      /' || echo "      Erreur lors de la lecture des logs"
        else
            echo -e "${RED}âŒ ArrÃªtÃ© ou non trouvÃ©${NC}"
        fi
        echo ""
    done
    
    echo -e "${CYAN}ğŸ”§ Informations de debugging:${NC}"
    echo "  â€¢ Docker version: $(docker --version 2>/dev/null || echo 'Non disponible')"
    echo "  â€¢ Docker Compose version: $(docker-compose --version 2>/dev/null || echo 'Non disponible')"
    echo "  â€¢ RÃ©pertoire courant: $(pwd)"
    echo "  â€¢ Fichiers docker-compose disponibles:"
    ls -la docker-compose*.yml 2>/dev/null | sed 's/^/    /' || echo "    Aucun fichier docker-compose trouvÃ©"
    
    pause
}

# Fonction pour lancer les tests automatisÃ©s
run_tests() {
    echo -e "\n${GREEN}ğŸ§ª Lancement des tests automatisÃ©s...${NC}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    # VÃ©rifier si docker-compose.test.yml existe
    if [[ ! -f "docker-compose.test.yml" ]]; then
        echo -e "${RED}âŒ Erreur: docker-compose.test.yml non trouvÃ©${NC}"
        echo "Ce fichier est nÃ©cessaire pour l'environnement de test isolÃ©."
        pause
        return 1
    fi
    
    echo -e "\n${CYAN}ğŸš€ Options de test disponibles:${NC}"
    echo -e "${WHITE}  1)${NC} ğŸƒ Lancer tous les tests"
    echo -e "${WHITE}  2)${NC} ğŸ“Š Lancer les tests avec couverture"
    echo -e "${WHITE}  3)${NC} ğŸ” Tests spÃ©cifiques (routes utilisateur)"
    echo -e "${WHITE}  4)${NC} ğŸ”§ Mode debug (logs dÃ©taillÃ©s)"
    echo -e "${WHITE}  5)${NC} ğŸ§¹ Nettoyer l'environnement de test"
    echo -e "${WHITE}  0)${NC} âŒ Retour au menu principal"
    echo ""
    read -p "Votre choix (0-5): " test_choice
    
    case $test_choice in
        1)
            echo -e "\n${BLUE}ğŸš€ DÃ©marrage de l'environnement de test...${NC}"
            docker-compose -f docker-compose.test.yml up -d
            
            echo -e "\n${BLUE}â³ Attente que les services soient prÃªts...${NC}"
            sleep 5
            
            echo -e "\n${GREEN}ğŸ§ª ExÃ©cution de tous les tests...${NC}"
            docker-compose -f docker-compose.test.yml exec api npm test
            
            echo -e "\n${YELLOW}ğŸ›‘ ArrÃªt de l'environnement de test...${NC}"
            docker-compose -f docker-compose.test.yml down
            ;;
        2)
            echo -e "\n${BLUE}ğŸš€ DÃ©marrage de l'environnement de test...${NC}"
            docker-compose -f docker-compose.test.yml up -d
            
            echo -e "\n${BLUE}â³ Attente que les services soient prÃªts...${NC}"
            sleep 5
            
            echo -e "\n${GREEN}ğŸ“Š ExÃ©cution des tests avec couverture...${NC}"
            docker-compose -f docker-compose.test.yml exec api npm run test:coverage
            
            echo -e "\n${YELLOW}ğŸ›‘ ArrÃªt de l'environnement de test...${NC}"
            docker-compose -f docker-compose.test.yml down
            ;;
        3)
            echo -e "\n${BLUE}ğŸš€ DÃ©marrage de l'environnement de test...${NC}"
            docker-compose -f docker-compose.test.yml up -d
            
            echo -e "\n${BLUE}â³ Attente que les services soient prÃªts...${NC}"
            sleep 5
            
            echo -e "\n${GREEN}ğŸ” Tests des routes utilisateur...${NC}"
            docker-compose -f docker-compose.test.yml exec api npm test -- --testNamePattern="user"
            
            echo -e "\n${YELLOW}ğŸ›‘ ArrÃªt de l'environnement de test...${NC}"
            docker-compose -f docker-compose.test.yml down
            ;;
        4)
            echo -e "\n${BLUE}ğŸš€ DÃ©marrage de l'environnement de test...${NC}"
            docker-compose -f docker-compose.test.yml up -d
            
            echo -e "\n${BLUE}â³ Attente que les services soient prÃªts...${NC}"
            sleep 5
            
            echo -e "\n${GREEN}ğŸ”§ Tests en mode debug...${NC}"
            echo -e "${CYAN}Logs dÃ©taillÃ©s activÃ©s${NC}"
            docker-compose -f docker-compose.test.yml exec api sh -c "DEBUG=* npm test"
            
            echo -e "\n${YELLOW}ğŸ›‘ ArrÃªt de l'environnement de test...${NC}"
            docker-compose -f docker-compose.test.yml down
            ;;
        5)
            echo -e "\n${YELLOW}ğŸ§¹ Nettoyage de l'environnement de test...${NC}"
            echo -e "${RED}âš ï¸  Cela va supprimer:${NC}"
            echo "   â€¢ Les containers de test"
            echo "   â€¢ Les volumes de test (base de donnÃ©es de test)"
            echo ""
            read -p "Confirmer le nettoyage ? (y/N): " confirm
            
            if [[ "$confirm" =~ ^[Yy]$ ]]; then
                echo "ğŸ›‘ ArrÃªt et suppression des containers de test..."
                docker-compose -f docker-compose.test.yml down -v
                
                echo "ğŸ—‘ï¸ Suppression des images de test..."
                docker images | grep "test" | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null
                
                echo -e "${GREEN}âœ… Environnement de test nettoyÃ© !${NC}"
            else
                echo -e "${YELLOW}Nettoyage annulÃ©${NC}"
            fi
            ;;
        0)
            echo -e "${YELLOW}Retour au menu principal...${NC}"
            return 0
            ;;
        *)
            echo -e "\n${RED}âŒ Choix invalide.${NC}"
            ;;
    esac
    
    echo -e "\n${CYAN}ğŸ’¡ Conseils pour les tests:${NC}"
    echo "   â€¢ Consultez docs/guides/GUIDE-TESTS-DOCKER.md pour plus d'informations"
    echo "   â€¢ Les tests utilisent une base de donnÃ©es isolÃ©e (db-test)"
    echo "   â€¢ Aucune donnÃ©e de dÃ©veloppement n'est affectÃ©e"
    
    pause
}

# Fonction pour lancer automatiquement les tÃ¢ches VS Code de logs
launch_vscode_logs_task() {
    local environment="$1"
    local task_name=""
    
    if [[ "$environment" == "dÃ©veloppement" ]]; then
        task_name="ğŸš€ Ouvrir TOUS les Logs (DÃ©veloppement)"
    else
        task_name="ğŸ­ Ouvrir TOUS les Logs (Production)"
    fi
    
    echo -e "\n${CYAN}ğŸš€ Tentative de lancement automatique de la tÃ¢che VS Code...${NC}"
    
    # VÃ©rifier si la commande 'code' est disponible
    if command -v code &> /dev/null; then
        echo -e "${GREEN}âœ… VS Code CLI dÃ©tectÃ© !${NC}"
        
        # VÃ©rifier si VS Code est dÃ©jÃ  ouvert dans ce workspace
        local workspace_path="$(pwd)"
        
        # MÃ©thode 1: Essayer de lancer la tÃ¢che directement
        echo -e "${YELLOW}ğŸ¯ Tentative de lancement direct de la tÃ¢che...${NC}"
        
        # Utiliser une approche JSON pour dÃ©clencher la tÃ¢che
        local temp_script="/tmp/launch_vscode_task.sh"
        cat > "$temp_script" << EOF
#!/bin/bash
# Script temporaire pour lancer la tÃ¢che VS Code
echo "Lancement de la tÃ¢che VS Code: $task_name"
cd "$workspace_path"
code --command "workbench.action.tasks.runTask" --args "$task_name" . 2>/dev/null &
sleep 2
exit 0
EOF
        
        chmod +x "$temp_script"
        
        if "$temp_script" 2>/dev/null; then
            echo -e "${GREEN}âœ… Commande lancÃ©e !${NC}"
            echo -e "${CYAN}â¡ï¸  Si VS Code est ouvert, la tÃ¢che '${task_name}' devrait se lancer automatiquement${NC}"
            echo -e "${YELLOW}ğŸ“ Sinon, utilisez Ctrl+Shift+P dans VS Code et tapez le nom de la tÃ¢che${NC}"
            rm -f "$temp_script" 2>/dev/null
            return 0
        else
            echo -e "${YELLOW}âš ï¸  Lancement direct Ã©chouÃ©, ouverture de VS Code...${NC}"
            rm -f "$temp_script" 2>/dev/null
        fi
        
        # MÃ©thode 2: Ouvrir VS Code dans le workspace
        echo -e "${YELLOW}ğŸ“‚ Ouverture de VS Code dans le workspace...${NC}"
        
        if code "$workspace_path" 2>/dev/null; then
            echo -e "${GREEN}âœ… VS Code ouvert avec succÃ¨s !${NC}"
            echo -e "${CYAN}â¡ï¸  Dans VS Code:${NC}"
            echo -e "   1. Appuyez sur ${WHITE}Ctrl+Shift+P${NC}"
            echo -e "   2. Tapez: ${YELLOW}${task_name}${NC}"
            echo -e "   3. Appuyez sur ${WHITE}EntrÃ©e${NC}"
            echo -e "${GREEN}ğŸ‰ Tous les logs s'ouvriront automatiquement !${NC}"
            return 0
        else
            echo -e "${RED}âŒ Erreur lors de l'ouverture de VS Code${NC}"
            return 1
        fi
    else
        echo -e "${RED}âŒ VS Code CLI ('code') non trouvÃ© dans le PATH${NC}"
        echo -e "${YELLOW}ğŸ’¡ Pour installer VS Code CLI:${NC}"
        echo -e "   1. Ouvrez VS Code"
        echo -e "   2. ${WHITE}Ctrl+Shift+P${NC} â†’ tapez: ${CYAN}Shell Command: Install 'code' command in PATH${NC}"
        echo -e "   3. RedÃ©marrez votre terminal"
        echo -e "   4. Relancez ce script"
        return 1
    fi
}

# Fonction principale
main() {
    while true; do
        show_header
        show_status
        show_menu
        
        read -p "Votre choix: " choice
        
        case $choice in
            1) start_development ;;
            2) start_production ;;
            3) start_service ;;
            4) stop_service ;;
            5) restart_service ;;
            6) build_service ;;
            7) show_status; pause ;;
            8) view_logs ;;
            9) follow_logs ;;
            10) open_shell ;;
            11) open_logs_terminals_menu ;;
            12) stop_all ;;
            13) cleanup ;;
            14) full_restart ;;
            15) backup_database ;;
            16) show_resources ;;
            17) open_urls ;;
            18) diagnostic_services ;;
            19) run_tests ;;
            20) quick_start_development ;;
            21) quick_start_production ;;
            22) quick_start_tests ;;
            0) 
                echo -e "\n${GREEN}ğŸ‘‹ Au revoir !${NC}"
                exit 0
                ;;
            *)
                echo -e "\n${RED}âŒ Choix invalide. Veuillez rÃ©essayer.${NC}"
                pause
                ;;
        esac
    done
}

# VÃ©rifier que Docker et Docker Compose sont installÃ©s
if ! command -v docker &> /dev/null; then
    echo -e "${RED}âŒ Docker n'est pas installÃ© ou n'est pas dans le PATH${NC}"
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo -e "${RED}âŒ Docker Compose n'est pas installÃ© ou n'est pas dans le PATH${NC}"
    exit 1
fi

# VÃ©rifier que nous sommes dans le bon rÃ©pertoire
if [[ ! -f "docker-compose.yml" ]]; then
    echo -e "${RED}âŒ Fichier docker-compose.yml non trouvÃ©. Assurez-vous d'Ãªtre dans le rÃ©pertoire racine du projet.${NC}"
    exit 1
fi

# Lancer le script principal
main
